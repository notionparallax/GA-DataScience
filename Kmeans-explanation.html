<html>

<head>
<style type="text/css">
.knitr.inline {
  background-color: #f7f7f7;
  border:solid 1px #B0B0B0;
}
.error {
	font-weight: bold;
	color: #FF0000;
},
.warning {
	font-weight: bold;
}
.message {
	font-style: italic;
}
.source, .output, .warning, .error, .message {
	padding: 0em 1em;
  border:solid 1px #F7F7F7;
}
.source {
  background-color: #f5f5f5;
}
.rimage.left {
  text-align: left;
}
.rimage.right {
  text-align: right;
}
.rimage.center {
  text-align: center;
}
.hl.num {
  color: #AF0F91;
}
.hl.str {
  color: #317ECC;
}
.hl.com {
  color: #AD95AF;
  font-style: italic;
}
.hl.opt {
  color: #000000;
}
.hl.std {
  color: #585858;
}
.hl.kwa {
  color: #295F94;
  font-weight: bold;
}
.hl.kwb {
  color: #B05A65;
}
.hl.kwc {
  color: #55aa55;
}
.hl.kwd {
  color: #BC5A65;
  font-weight: bold;
}
</style>
<title>K Means example | R</title>
</head>

<body>
<p>K Means is a clustering method to <em>find</em> groups in data.</p>
<p>Begin by importing the <code>stats</code> library, which contains the <code>kmeans</code> implementation we'll be using.</p>
<div class="chunk" id="import some libraries"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl str">&quot;stats&quot;</span> <span class="hl opt">%in%</span> <span class="hl kwd">rownames</span><span class="hl std">(</span><span class="hl kwd">installed.packages</span><span class="hl std">())</span> <span class="hl opt">==</span> <span class="hl num">FALSE</span><span class="hl std">) {</span>
    <span class="hl kwd">install.packages</span><span class="hl std">(</span><span class="hl str">&quot;stats&quot;</span><span class="hl std">)</span>
<span class="hl std">}</span>  <span class="hl com">#this line checks if the package is installed and if it isn't, installs it.</span>
<span class="hl kwd">library</span><span class="hl std">(stats)</span>
<span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl str">&quot;ggplot2&quot;</span> <span class="hl opt">%in%</span> <span class="hl kwd">rownames</span><span class="hl std">(</span><span class="hl kwd">installed.packages</span><span class="hl std">())</span> <span class="hl opt">==</span> <span class="hl num">FALSE</span><span class="hl std">) {</span>
    <span class="hl kwd">install.packages</span><span class="hl std">(</span><span class="hl str">&quot;ggplot2&quot;</span><span class="hl std">)</span>
<span class="hl std">}</span>
<span class="hl kwd">library</span><span class="hl std">(ggplot2)</span>
<span class="hl kwd">set.seed</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">)</span>
</pre></div>
</div></div>


<p>For our first example, let's create some synthetic easy-to-cluster data. This generates 4 little clouds of points , each as a dataframe, and joins them all into one data frame. (Adding more rows onto the bottom, not more collumns.)</p>
<div class="chunk" id="make some example data"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">d</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">data.frame</span><span class="hl std">()</span>
<span class="hl std">d</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(d,</span> <span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">=</span> <span class="hl num">1</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">0.1</span><span class="hl std">),</span> <span class="hl kwc">y</span> <span class="hl std">=</span> <span class="hl num">1</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">0.1</span><span class="hl std">),</span>
    <span class="hl kwc">label</span> <span class="hl std">=</span> <span class="hl kwd">as.factor</span><span class="hl std">(</span><span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">1</span><span class="hl std">,</span> <span class="hl kwc">each</span> <span class="hl std">=</span> <span class="hl num">20</span><span class="hl std">))))</span>
<span class="hl std">d</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(d,</span> <span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">=</span> <span class="hl num">1</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">0.1</span><span class="hl std">),</span> <span class="hl kwc">y</span> <span class="hl std">=</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">0.1</span><span class="hl std">),</span>
    <span class="hl kwc">label</span> <span class="hl std">=</span> <span class="hl kwd">as.factor</span><span class="hl std">(</span><span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">2</span><span class="hl std">,</span> <span class="hl kwc">each</span> <span class="hl std">=</span> <span class="hl num">20</span><span class="hl std">))))</span>
<span class="hl std">d</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(d,</span> <span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">=</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">0.1</span><span class="hl std">),</span> <span class="hl kwc">y</span> <span class="hl std">=</span> <span class="hl num">1</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">0.1</span><span class="hl std">),</span>
    <span class="hl kwc">label</span> <span class="hl std">=</span> <span class="hl kwd">as.factor</span><span class="hl std">(</span><span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">3</span><span class="hl std">,</span> <span class="hl kwc">each</span> <span class="hl std">=</span> <span class="hl num">20</span><span class="hl std">))))</span>
<span class="hl std">d</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(d,</span> <span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">=</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">0.1</span><span class="hl std">),</span> <span class="hl kwc">y</span> <span class="hl std">=</span> <span class="hl num">3</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">0.1</span><span class="hl std">),</span>
    <span class="hl kwc">label</span> <span class="hl std">=</span> <span class="hl kwd">as.factor</span><span class="hl std">(</span><span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">4</span><span class="hl std">,</span> <span class="hl kwc">each</span> <span class="hl std">=</span> <span class="hl num">20</span><span class="hl std">))))</span>
</pre></div>
</div></div>

<p>This ends up with a dataframe that looks something like this:</p>
<div class="chunk" id="unnamed-chunk-1"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">head</span><span class="hl std">(d)</span>
</pre></div>
<div class="output"><pre class="knitr r">##        x      y label
## 1 0.9374 1.0919     1
## 2 1.0184 1.0782     1
## 3 0.9164 1.0075     1
## 4 1.1595 0.8011     1
## 5 1.0330 1.0620     1
## 6 0.9180 0.9944     1
</pre></div>
</div></div>

<p>have a look...this looks easy enough</p>
<div class="chunk" id="show the base data"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com"># TODO: this plot isn't showing any more, fix it</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= label))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;d -- easy clusters&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/show the base data.png" title="plot of chunk show the base data" alt="plot of chunk show the base data" class="plot" /></div></div>

<p>perform clustering</p>
<div class="chunk" id="unnamed-chunk-2"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(d[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl num">4</span><span class="hl std">)</span>
</pre></div>
</div></div>

<p><code>kmeans(x, centers, ...</code></p>
<table>
<tr><td>x</td><td>numeric matrix of data, or an object that can be coerced to such a matrix (such as a numeric vector or a data frame with all numeric columns).</td></tr>
<tr><td>centers</td><td>either the number of clusters, say k, or a set of initial (distinct) cluster centres. If a number, a random set of (distinct) rows in x is chosen as the initial centres.</td></tr>
<table>

<p>lets compare a few cluster solutions</p>
<div class="chunk" id="unnamed-chunk-3"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result12</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(d[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl num">2</span><span class="hl std">)</span>
<span class="hl std">d</span><span class="hl opt">$</span><span class="hl std">cluster12</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result12</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster12))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result1 -- (k=2)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-3.png" title="plot of chunk unnamed-chunk-3" alt="plot of chunk unnamed-chunk-3" class="plot" /></div></div>

<p>With two centroids searching for clusters to own it tends to pick two of the obvious clusters and treat them as one.</p>
<div class="chunk" id="unnamed-chunk-4"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result13</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(d[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl num">3</span><span class="hl std">)</span>
<span class="hl std">d</span><span class="hl opt">$</span><span class="hl std">cluster13</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result13</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster13))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result1 -- (k=3)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-4.png" title="plot of chunk unnamed-chunk-4" alt="plot of chunk unnamed-chunk-4" class="plot" /></div></div>

<p>With three centres it finds two of the obvious clusters, but groups the remaining two together</p>
<div class="chunk" id="unnamed-chunk-5"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result14</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(d[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl num">4</span><span class="hl std">)</span>
<span class="hl std">d</span><span class="hl opt">$</span><span class="hl std">cluster14</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result14</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster14))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result1 -- (k=4)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-5.png" title="plot of chunk unnamed-chunk-5" alt="plot of chunk unnamed-chunk-5" class="plot" /></div></div>

<p>Four behaves exactly as you would expect it to!</p>
<div class="chunk" id="unnamed-chunk-6"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result15</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(d[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl num">5</span><span class="hl std">)</span>
<span class="hl std">d</span><span class="hl opt">$</span><span class="hl std">cluster15</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result15</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster15))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result1 -- (k=5)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-6.png" title="plot of chunk unnamed-chunk-6" alt="plot of chunk unnamed-chunk-6" class="plot" /></div></div>

<p>with 5 centres it tries to pick off a few weak points at the edge of one of the herds and call them a group.</p>

<h3>Examining the results</h3>
<div class="from-help">
<h5>Value</h5>

<p>kmeans returns an object of class "kmeans" which has a print and a fitted method. It is a list with components:</p>
<table>
<tr><td>cluster</td><td>A vector of integers (from 1:k) indicating the cluster to which each point is allocated.</td></tr>
<tr><td>centers</td><td>A matrix of cluster centres.</td></tr>
<tr><td>totss</td><td>The total sum of squares.</td></tr>
<tr><td>withinss</td><td>Vector of within-cluster sum of squares, one component per cluster.</td></tr>
<tr><td>tot.withinss</td><td>Total within-cluster sum of squares, i.e., sum(withinss).</td></tr>
<tr><td>betweenss</td><td>The between-cluster sum of squares, i.e. totss-tot.withinss.</td></tr>
<tr><td>size</td><td>The number of points in each cluster.</td></tr>
<table>
</div>
<div class="chunk" id="unnamed-chunk-7"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">res.comp</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.data.frame</span><span class="hl std">(</span><span class="hl kwd">rbind</span><span class="hl std">(</span><span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">2</span><span class="hl std">, result12</span><span class="hl opt">$</span><span class="hl std">tot.withinss),</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">3</span><span class="hl std">, result13</span><span class="hl opt">$</span><span class="hl std">tot.withinss),</span>
    <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">4</span><span class="hl std">, result14</span><span class="hl opt">$</span><span class="hl std">tot.withinss),</span> <span class="hl kwd">c</span><span class="hl std">(</span><span class="hl num">5</span><span class="hl std">, result15</span><span class="hl opt">$</span><span class="hl std">tot.withinss)))</span>

<span class="hl kwd">ggplot</span><span class="hl std">(res.comp,</span> <span class="hl kwd">aes</span><span class="hl std">(res.comp[,</span> <span class="hl num">1</span><span class="hl std">],</span> <span class="hl kwd">as.numeric</span><span class="hl std">(res.comp[,</span> <span class="hl num">2</span><span class="hl std">])))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_line</span><span class="hl std">()</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-7.png" title="plot of chunk unnamed-chunk-7" alt="plot of chunk unnamed-chunk-7" class="plot" /></div></div>

<p>The Total within-cluster sum of squares decreases rapidly as it finds the 'real' clusters, and then levels off as it starts to make a stab at what might be a cluster.</p>
<h3>Results</h3>
<p>Here are the results...note the algorithm found clusters whose means are close to the true means of our synthetic clusters</p>
<div class="chunk" id="unnamed-chunk-8"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl com"># remember result1 came from this line above: result1 &lt;- kmeans(d[,1:2], 4)</span>
<span class="hl std">result1</span>
</pre></div>
<div class="output"><pre class="knitr r">## K-means clustering with 4 clusters of sizes 20, 20, 20, 20
## 
## Cluster means:
##       x      y
## 1 3.012 1.0114
## 2 1.019 0.9994
## 3 1.014 3.0102
## 4 2.978 2.9596
## 
## Clustering vector:
##  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 
##  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2  3  3  3  3  3 
## 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 
##  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  1  1  1  1  1  1  1  1  1  1 
## 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 
##  1  1  1  1  1  1  1  1  1  1  4  4  4  4  4  4  4  4  4  4  4  4  4  4  4 
## 76 77 78 79 80 
##  4  4  4  4  4 
## 
## Within cluster sum of squares by cluster:
## [1] 0.2836 0.3027 0.3342 0.3510
##  (between_SS / total_SS =  99.2 %)
## 
## Available components:
## 
## [1] "cluster"      "centers"      "totss"        "withinss"    
## [5] "tot.withinss" "betweenss"    "size"
</pre></div>
</div></div>

<p>plot results...we are looking good</p>
<div class="chunk" id="unnamed-chunk-9"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">d</span><span class="hl opt">$</span><span class="hl std">cluster1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result1</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster1))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result1 -- success!\n(k=4)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-9.png" title="plot of chunk unnamed-chunk-9" alt="plot of chunk unnamed-chunk-9" class="plot" /></div></div>

<p>suppose we repeat these steps...what do you expect to happen?</p>
<div class="chunk" id="unnamed-chunk-10"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwd">set.seed</span><span class="hl std">(</span><span class="hl num">2</span><span class="hl std">)</span>
<span class="hl std">result2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(d[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl num">4</span><span class="hl std">)</span>
<span class="hl std">result2</span>
</pre></div>
<div class="output"><pre class="knitr r">## K-means clustering with 4 clusters of sizes 20, 20, 20, 20
## 
## Cluster means:
##       x      y
## 1 1.019 0.9994
## 2 2.978 2.9596
## 3 3.012 1.0114
## 4 1.014 3.0102
## 
## Clustering vector:
##  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 
##  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  4  4  4  4  4 
## 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 
##  4  4  4  4  4  4  4  4  4  4  4  4  4  4  4  3  3  3  3  3  3  3  3  3  3 
## 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 
##  3  3  3  3  3  3  3  3  3  3  2  2  2  2  2  2  2  2  2  2  2  2  2  2  2 
## 76 77 78 79 80 
##  2  2  2  2  2 
## 
## Within cluster sum of squares by cluster:
## [1] 0.3027 0.3510 0.2836 0.3342
##  (between_SS / total_SS =  99.2 %)
## 
## Available components:
## 
## [1] "cluster"      "centers"      "totss"        "withinss"    
## [5] "tot.withinss" "betweenss"    "size"
</pre></div>
</div></div>


<div class="chunk" id="unnamed-chunk-11"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result1</span><span class="hl opt">$</span><span class="hl std">betweenss</span><span class="hl opt">/</span><span class="hl std">result1</span><span class="hl opt">$</span><span class="hl std">totss</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] 0.992
</pre></div>
</div></div>

    
<div class="chunk" id="unnamed-chunk-12"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result2</span><span class="hl opt">$</span><span class="hl std">betweenss</span><span class="hl opt">/</span><span class="hl std">result2</span><span class="hl opt">$</span><span class="hl std">totss</span>
</pre></div>
<div class="output"><pre class="knitr r">## [1] 0.992
</pre></div>
</div></div>

<p>Notice that the fit got worse!<br><div style="float:right; width:300px; font-size:2em; background-color:yellow; padding: 0.5em;">The problem is, I <em>don't</em> notice the fit getting worse, even with a new random seed before I run the second kmeans I get exactly the same results both times.</div>
(e.g. large decrease in between_SS / total_SS...also cluster means are not as good as before)</p>
<p>and this scatterplot shows that something is obviously not right...what happened?</p>
<div class="chunk" id="unnamed-chunk-13"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">d</span><span class="hl opt">$</span><span class="hl std">cluster2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result2</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster2))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result2 -- trouble\n(k=4)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-13.png" title="plot of chunk unnamed-chunk-13" alt="plot of chunk unnamed-chunk-13" class="plot" /></div></div>

<p>This instability is a result of the random initial seeds that the clustering algorithm uses if two initial seeds begin in the same cluster, then the algorithm will have difficulty finding all the clusters (in particular, the cluster which doesn't contain an initial seed will be difficult to identify)<br>
(note that in any case, the algorithm will still return exactly as many clusters as you asked it to!)</p>

</p>So how can we create a more stable clustering fit? By repeating the fit several times and taking an average (this is effectively an ensemble clustering technique...we will talk about ensemble methods in more detail later)</p>
<div class="chunk" id="unnamed-chunk-14"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result3</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(d[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl num">4</span><span class="hl std">,</span> <span class="hl kwc">nstart</span> <span class="hl std">=</span> <span class="hl num">10</span><span class="hl std">)</span>
<span class="hl std">result3</span>
</pre></div>
<div class="output"><pre class="knitr r">## K-means clustering with 4 clusters of sizes 20, 20, 20, 20
## 
## Cluster means:
##       x      y
## 1 1.014 3.0102
## 2 3.012 1.0114
## 3 1.019 0.9994
## 4 2.978 2.9596
## 
## Clustering vector:
##  1  2  3  4  5  6  7  8  9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 
##  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  3  1  1  1  1  1 
## 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 
##  1  1  1  1  1  1  1  1  1  1  1  1  1  1  1  2  2  2  2  2  2  2  2  2  2 
## 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 
##  2  2  2  2  2  2  2  2  2  2  4  4  4  4  4  4  4  4  4  4  4  4  4  4  4 
## 76 77 78 79 80 
##  4  4  4  4  4 
## 
## Within cluster sum of squares by cluster:
## [1] 0.3342 0.2836 0.3027 0.3510
##  (between_SS / total_SS =  99.2 %)
## 
## Available components:
## 
## [1] "cluster"      "centers"      "totss"        "withinss"    
## [5] "tot.withinss" "betweenss"    "size"
</pre></div>
<div class="source"><pre class="knitr r"><span class="hl std">d</span><span class="hl opt">$</span><span class="hl std">cluster3</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result3</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster3))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result3 -- stable convergence\n(k=4, nstart=10)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-14.png" title="plot of chunk unnamed-chunk-14" alt="plot of chunk unnamed-chunk-14" class="plot" /></div></div>

<p>What happens if we introduce a new length scale into the problem? how many clusters are in the dataset now?</p>
<div class="chunk" id="unnamed-chunk-15"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">d2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">rbind</span><span class="hl std">(d[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">3</span><span class="hl std">],</span> <span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">=</span> <span class="hl num">1000</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span> <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">50</span><span class="hl std">),</span> <span class="hl kwc">y</span> <span class="hl std">=</span> <span class="hl num">1000</span> <span class="hl opt">+</span> <span class="hl kwd">rnorm</span><span class="hl std">(</span><span class="hl num">20</span><span class="hl std">,</span>
    <span class="hl num">0</span><span class="hl std">,</span> <span class="hl num">50</span><span class="hl std">),</span> <span class="hl kwc">label</span> <span class="hl std">=</span> <span class="hl kwd">as.factor</span><span class="hl std">(</span><span class="hl kwd">rep</span><span class="hl std">(</span><span class="hl num">5</span><span class="hl std">,</span> <span class="hl kwc">each</span> <span class="hl std">=</span> <span class="hl num">20</span><span class="hl std">))))</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d2,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= label))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;d2 -- multiple length scales&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-15.png" title="plot of chunk unnamed-chunk-15" alt="plot of chunk unnamed-chunk-15" class="plot" /></div></div>

<p>as you can see, things go haywire...recall that clustering results are kind of a heuristic<br>
(in particular, not invariant to a change in units!)</p>
<div class="chunk" id="unnamed-chunk-16"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">result4</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(d2[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl num">5</span><span class="hl std">,</span> <span class="hl kwc">nstart</span> <span class="hl std">=</span> <span class="hl num">10</span><span class="hl std">)</span>
<span class="hl std">d2</span><span class="hl opt">$</span><span class="hl std">cluster4</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result4</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(d2,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster4))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result4 -- trouble\n(k=5, nstart=10)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-16.png" title="plot of chunk unnamed-chunk-16" alt="plot of chunk unnamed-chunk-16" class="plot" /></div></div>

<p>Lets standardis the variables and see what happens</p>
<div class="chunk" id="unnamed-chunk-17"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">ds</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">data.frame</span><span class="hl std">(</span><span class="hl kwd">scale</span><span class="hl std">(d2[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">2</span><span class="hl std">],</span> <span class="hl kwc">center</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">,</span> <span class="hl kwc">scale</span> <span class="hl std">=</span> <span class="hl num">TRUE</span><span class="hl std">))</span>
<span class="hl std">result5</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(ds,</span> <span class="hl num">4</span><span class="hl std">,</span> <span class="hl kwc">nstart</span> <span class="hl std">=</span> <span class="hl num">10</span><span class="hl std">)</span>
<span class="hl std">ds</span><span class="hl opt">$</span><span class="hl std">cluster4</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">as.factor</span><span class="hl std">(result5</span><span class="hl opt">$</span><span class="hl std">cluster)</span>
<span class="hl kwd">ggplot</span><span class="hl std">(ds,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= x,</span> <span class="hl kwc">y</span> <span class="hl std">= y))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster4))</span> <span class="hl opt">+</span> <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;kmeans result5 -- trouble\n(k=5, nstart=10)&quot;</span><span class="hl std">)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-17.png" title="plot of chunk unnamed-chunk-17" alt="plot of chunk unnamed-chunk-17" class="plot" /></div></div>

<p>now let's try k-means clustering with the iris dataset</p>
<div class="chunk" id="unnamed-chunk-18"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">iris.result</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">kmeans</span><span class="hl std">(iris[,</span> <span class="hl num">1</span><span class="hl opt">:</span><span class="hl num">4</span><span class="hl std">],</span> <span class="hl num">3</span><span class="hl std">)</span>
</pre></div>
</div></div>

<p>look at clustering results...you can already tell something is up</p>
<div class="chunk" id="unnamed-chunk-19"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">iris.result</span><span class="hl opt">$</span><span class="hl std">cluster</span>
</pre></div>
<div class="output"><pre class="knitr r">##   [1] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3
##  [36] 3 3 3 3 3 3 3 3 3 3 3 3 3 3 3 2 2 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2
##  [71] 2 2 2 2 2 2 2 1 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 2 1 2 1 1 1
## [106] 1 2 1 1 1 1 1 1 2 2 1 1 1 1 2 1 2 1 2 1 1 2 2 1 1 1 1 1 2 1 1 1 1 2 1
## [141] 1 1 2 1 1 1 2 1 1 2
</pre></div>
</div></div>

<p>Combine clustering results with input data (as factor)</p>
<p>Let's look at the scatterplots of clustering results & true labels together (using package gridExtra)</p>
<p>First install this guy</p>
<div class="chunk" id="unnamed-chunk-20"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl kwa">if</span> <span class="hl std">(</span><span class="hl str">&quot;gridExtra&quot;</span> <span class="hl opt">%in%</span> <span class="hl kwd">rownames</span><span class="hl std">(</span><span class="hl kwd">installed.packages</span><span class="hl std">())</span> <span class="hl opt">==</span> <span class="hl num">FALSE</span><span class="hl std">) {</span>
    <span class="hl kwd">install.packages</span><span class="hl std">(</span><span class="hl str">&quot;gridExtra&quot;</span><span class="hl std">)</span>
<span class="hl std">}</span>
<span class="hl kwd">library</span><span class="hl std">(gridExtra)</span>
</pre></div>
<div class="message"><pre class="knitr r">## Loading required package: grid
</pre></div>
</div></div>

<p>now create our two scatterplots...note that ggplot returns an *object* which can be stored!</p>
<div class="chunk" id="unnamed-chunk-21"><div class="rcode"><div class="source"><pre class="knitr r"><span class="hl std">iris2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">cbind</span><span class="hl std">(iris,</span> <span class="hl kwc">cluster</span> <span class="hl std">=</span> <span class="hl kwd">as.factor</span><span class="hl std">(iris.result</span><span class="hl opt">$</span><span class="hl std">cluster))</span>
<span class="hl std">p1</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ggplot</span><span class="hl std">(iris2,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= Sepal.Width,</span> <span class="hl kwc">y</span> <span class="hl std">= Petal.Width))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= cluster))</span> <span class="hl opt">+</span>
    <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;clustering results&quot;</span><span class="hl std">)</span>
<span class="hl std">p2</span> <span class="hl kwb">&lt;-</span> <span class="hl kwd">ggplot</span><span class="hl std">(iris,</span> <span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">x</span> <span class="hl std">= Sepal.Width,</span> <span class="hl kwc">y</span> <span class="hl std">= Petal.Width))</span> <span class="hl opt">+</span> <span class="hl kwd">geom_point</span><span class="hl std">(</span><span class="hl kwd">aes</span><span class="hl std">(</span><span class="hl kwc">colour</span> <span class="hl std">= Species))</span> <span class="hl opt">+</span>
    <span class="hl kwd">ggtitle</span><span class="hl std">(</span><span class="hl str">&quot;true labels&quot;</span><span class="hl std">)</span>

<span class="hl kwd">grid.arrange</span><span class="hl std">(p1, p2)</span>
</pre></div>
</div><div class="rimage default"><img src="figure/unnamed-chunk-21.png" title="plot of chunk unnamed-chunk-21" alt="plot of chunk unnamed-chunk-21" class="plot" /></div></div>

<p>so what is going on here?</p>
<p>although clustering is a unsupervised learning technique it does an OK job at matching known groups</p>
</body>
</html>
